# üèóÔ∏è Documenta√ß√£o T√©cnica - Sistema de Autentica√ß√£o

## üìã Vis√£o Geral

Este documento descreve a arquitetura t√©cnica, fluxos de dados e implementa√ß√£o do sistema de autentica√ß√£o do Gestor de Notas Fiscais.

**Tecnologias**:
- **Backend**: Supabase Auth
- **Frontend**: Next.js 15, React 19, TypeScript
- **Prote√ß√£o**: Middleware (servidor) + AuthGuard (cliente)
- **Estado**: React Context API
- **Valida√ß√£o**: Zod + valida√ß√£o customizada
- **UI**: Tailwind CSS + shadcn/ui

---

## üèõÔ∏è Arquitetura

### Camadas de Seguran√ßa

O sistema implementa **defesa em profundidade** com 3 camadas:

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  1. MIDDLEWARE (Servidor)               ‚îÇ
‚îÇ  - Verifica sess√£o antes da p√°gina     ‚îÇ
‚îÇ  - Redireciona n√£o autenticados         ‚îÇ
‚îÇ  - Valida roles para rotas admin        ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
              ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  2. AUTHGUARD (Cliente)                 ‚îÇ
‚îÇ  - Prote√ß√£o adicional no React          ‚îÇ
‚îÇ  - Verifica roles espec√≠ficos            ‚îÇ
‚îÇ  - Fallbacks customiz√°veis               ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
              ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  3. RLS (Banco de Dados)                ‚îÇ
‚îÇ  - Pol√≠ticas no Supabase                ‚îÇ
‚îÇ  - Filtro autom√°tico de dados            ‚îÇ
‚îÇ  - Fail secure                           ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### Componentes Principais

```
src/
‚îú‚îÄ‚îÄ hooks/
‚îÇ   ‚îî‚îÄ‚îÄ useAuth.tsx              # Context Provider + hooks
‚îú‚îÄ‚îÄ lib/
‚îÇ   ‚îú‚îÄ‚îÄ auth.ts                  # Fun√ß√µes de autentica√ß√£o
‚îÇ   ‚îú‚îÄ‚îÄ authErrors.ts            # Tradu√ß√£o de erros
‚îÇ   ‚îî‚îÄ‚îÄ logger.ts                # Logger com controle por env
‚îú‚îÄ‚îÄ components/
‚îÇ   ‚îî‚îÄ‚îÄ Auth/
‚îÇ       ‚îú‚îÄ‚îÄ LoginForm/           # Formul√°rio de login
‚îÇ       ‚îú‚îÄ‚îÄ RegisterForm/        # Formul√°rio de registro
‚îÇ       ‚îú‚îÄ‚îÄ RecoverPasswordForm/ # Recupera√ß√£o de senha
‚îÇ       ‚îú‚îÄ‚îÄ ResetPasswordForm/   # Redefini√ß√£o de senha
‚îÇ       ‚îú‚îÄ‚îÄ AuthGuard/           # Prote√ß√£o client-side
‚îÇ       ‚îî‚îÄ‚îÄ AuthErrorHandler/    # Handler de erros
‚îú‚îÄ‚îÄ app/
‚îÇ   ‚îú‚îÄ‚îÄ (auth)/                  # Route group p√∫blico
‚îÇ   ‚îú‚îÄ‚îÄ (protected)/             # Route group protegido
‚îÇ   ‚îî‚îÄ‚îÄ (admin)/                 # Route group admin
‚îî‚îÄ‚îÄ middleware.ts                # Prote√ß√£o server-side
```

---

## üîÑ Fluxos de Dados

### 1. Fluxo de Login

```
1. Usu√°rio acessa /login
   ‚Üì
2. Middleware: permite (rota p√∫blica)
   ‚Üì
3. P√°gina renderiza LoginForm
   ‚Üì
4. Usu√°rio preenche email/senha
   ‚Üì
5. Valida√ß√£o client-side (tempo real)
   ‚Üì
6. Submit ‚Üí useAuth.signIn(email, password)
   ‚Üì
7. auth.ts ‚Üí supabase.auth.signInWithPassword()
   ‚Üì
8. Supabase valida credenciais
   ‚Üì
9. Supabase retorna sess√£o + user
   ‚Üì
10. getCurrentUser() busca profile (users_profile)
    ‚Üì
11. setUser({ id, email, profile })
    ‚Üì
12. AuthContext atualizado (todos componentes notificados)
    ‚Üì
13. Toast: "Login realizado com sucesso!"
    ‚Üì
14. Router.push(redirect || "/")
    ‚Üì
15. Middleware: permite (usu√°rio autenticado)
    ‚Üì
16. Dashboard renderizado
```

### 2. Fluxo de Registro

```
1. Usu√°rio acessa /registro
   ‚Üì
2. Middleware: permite (rota p√∫blica)
   ‚Üì
3. P√°gina renderiza RegisterForm
   ‚Üì
4. Usu√°rio preenche nome, email, senha
   ‚Üì
5. Valida√ß√£o em tempo real:
   - Email: formato v√°lido
   - Senha: for√ßa (indicador visual)
   - Confirma√ß√£o: senhas coincidem
   ‚Üì
6. Submit ‚Üí useAuth.signUp(email, password, nome)
   ‚Üì
7. auth.ts ‚Üí supabase.auth.signUp()
   ‚Üì
8. Supabase cria usu√°rio no Auth
   ‚Üì
9. Supabase dispara trigger: create_user_profile()
   ‚Üì
10. Profile criado em users_profile (role: viewer)
    ‚Üì
11. Supabase envia email de verifica√ß√£o
    ‚Üì
12. Toast: "Cadastro realizado! Verifique seu email"
    ‚Üì
13. Router.push(/verificar-email?email=...)
    ‚Üì
14. Usu√°rio recebe email com link
    ‚Üì
15. Clica no link ‚Üí Supabase confirma email
    ‚Üì
16. Usu√°rio pode fazer login
```

### 3. Fluxo de Prote√ß√£o de Rota

```
MIDDLEWARE (executa em TODAS as requisi√ß√µes)
‚Üì
1. Criar Supabase client com cookies
   ‚Üì
2. await supabase.auth.getSession()
   ‚Üì
3. Tem sess√£o?
   ‚îú‚îÄ N√ÉO ‚Üí 4a
   ‚îî‚îÄ SIM ‚Üí 4b

4a. N√ÉO AUTENTICADO:
    ‚Üì
    Rota √© p√∫blica? (/login, /registro)
    ‚îú‚îÄ SIM ‚Üí Permitir acesso
    ‚îî‚îÄ N√ÉO ‚Üí Redirecionar para /login?redirect=...

4b. AUTENTICADO:
    ‚Üì
    Rota √© p√∫blica?
    ‚îú‚îÄ SIM ‚Üí Redirecionar para / (j√° est√° logado)
    ‚îî‚îÄ N√ÉO ‚Üí 5

5. Rota requer role espec√≠fica? (/admin/*)
   ‚îú‚îÄ N√ÉO ‚Üí Permitir acesso
   ‚îî‚îÄ SIM ‚Üí 6

6. Buscar profile do usu√°rio
   ‚Üì
7. Verificar se role √© suficiente
   ‚îú‚îÄ SIM ‚Üí Permitir acesso
   ‚îî‚îÄ N√ÉO ‚Üí Redirecionar para /?error=unauthorized
```

### 4. Fluxo de Logout

```
1. Usu√°rio clica em "Sair" (MenuNav)
   ‚Üì
2. handleLogout() executado
   ‚Üì
3. setIsLoggingOut(true)
   ‚Üì
4. UI: Spinner + "Saindo..."
   ‚Üì
5. await signOut()
   ‚Üì
6. auth.ts ‚Üí supabase.auth.signOut()
   ‚Üì
7. Supabase limpa sess√£o (cookies)
   ‚Üì
8. setUser(null) ‚Üí AuthContext limpo
   ‚Üì
9. Toast: "Logout realizado"
   ‚Üì
10. setTimeout 500ms (permite ver toast)
    ‚Üì
11. Router.push("/login")
    ‚Üì
12. Middleware: redireciona (sem sess√£o)
    ‚Üì
13. P√°gina de login exibida
```

---

## üóÑÔ∏è Estrutura do Banco de Dados

### Tabela: `users_profile`

```sql
CREATE TABLE users_profile (
  id UUID PRIMARY KEY REFERENCES auth.users(id) ON DELETE CASCADE,
  email TEXT NOT NULL UNIQUE,
  nome TEXT,
  role TEXT NOT NULL DEFAULT 'viewer' CHECK (role IN ('admin', 'accountant', 'viewer')),
  empresa_id UUID REFERENCES empresas(id),
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);
```

**Campos**:
- `id`: UUID que referencia `auth.users` (Supabase Auth)
- `email`: Email do usu√°rio (√∫nico)
- `nome`: Nome completo do usu√°rio
- `role`: N√≠vel de acesso (admin, accountant, viewer)
- `empresa_id`: Empresa associada (para accountant)
- `created_at`: Data de cria√ß√£o
- `updated_at`: Data de atualiza√ß√£o

### Pol√≠ticas RLS

```sql
-- Usu√°rios podem ver seu pr√≥prio profile
CREATE POLICY "Users can view own profile" ON users_profile
FOR SELECT USING (auth.uid() = id);

-- Usu√°rios podem atualizar seu pr√≥prio profile (exceto role)
CREATE POLICY "Users can update own profile" ON users_profile
FOR UPDATE USING (auth.uid() = id);

-- Admins podem ver todos os profiles
CREATE POLICY "Admins can view all profiles" ON users_profile
FOR SELECT USING (
  EXISTS (
    SELECT 1 FROM users_profile
    WHERE id = auth.uid() AND role = 'admin'
  )
);

-- Admins podem gerenciar profiles
CREATE POLICY "Admins can manage profiles" ON users_profile
FOR ALL USING (
  EXISTS (
    SELECT 1 FROM users_profile
    WHERE id = auth.uid() AND role = 'admin'
  )
);
```

### Trigger: Criar Profile Automaticamente

```sql
CREATE OR REPLACE FUNCTION public.create_user_profile()
RETURNS TRIGGER AS $$
BEGIN
  INSERT INTO public.users_profile (id, email, nome, role)
  VALUES (
    NEW.id,
    NEW.email,
    COALESCE(NEW.raw_user_meta_data->>'nome', NEW.email),
    'viewer'
  );
  RETURN NEW;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

CREATE TRIGGER on_auth_user_created
  AFTER INSERT ON auth.users
  FOR EACH ROW EXECUTE FUNCTION public.create_user_profile();
```

---

## üîë Sistema de Roles

### Hierarquia

```
admin (n√≠vel 3)
  ‚Üì pode tudo que accountant pode +
  ‚Üì gerenciar usu√°rios
  ‚Üì gerenciar todas as empresas
  
accountant (n√≠vel 2)
  ‚Üì pode tudo que viewer pode +
  ‚Üì criar/editar notas fiscais da sua empresa
  
viewer (n√≠vel 1)
  ‚Üì apenas visualizar dados
```

### Verifica√ß√£o de Role

**Hier√°rquica** (role >= required):
```typescript
const roleHierarchy = {
  admin: 3,
  accountant: 2,
  viewer: 1,
};

const userLevel = roleHierarchy[user.role];
const requiredLevel = roleHierarchy[requiredRole];
const hasPermission = userLevel >= requiredLevel;
```

**Lista** (role IN allowed):
```typescript
const allowedRoles = ['admin', 'accountant'];
const hasPermission = allowedRoles.includes(user.role);
```

### Adicionar Nova Role

1. **Atualizar tipo no TypeScript**:
```typescript
// src/types/models.ts
export type UserRole = 'admin' | 'accountant' | 'viewer' | 'nova_role';
```

2. **Atualizar constraint no banco**:
```sql
ALTER TABLE users_profile 
DROP CONSTRAINT users_profile_role_check;

ALTER TABLE users_profile 
ADD CONSTRAINT users_profile_role_check 
CHECK (role IN ('admin', 'accountant', 'viewer', 'nova_role'));
```

3. **Atualizar hierarquia**:
```typescript
// src/components/Auth/AuthGuard/index.tsx
const roleHierarchy = {
  admin: 4,
  nova_role: 3,
  accountant: 2,
  viewer: 1,
};
```

4. **Adicionar tradu√ß√£o**:
```typescript
// src/components/Admin/MenuNav/index.tsx
const roleNames = {
  admin: "Administrador",
  accountant: "Contador",
  viewer: "Visualizador",
  nova_role: "Nova Role",
};
```

---

## üõ°Ô∏è Seguran√ßa

### Princ√≠pios Implementados

1. **Nunca confie no cliente**
   - Valida√ß√£o no servidor (middleware)
   - RLS no banco de dados
   - Tokens seguros

2. **Defesa em profundidade**
   - 3 camadas de prote√ß√£o
   - Cada camada independente
   - Fail secure

3. **Menor privil√©gio**
   - Role padr√£o: viewer
   - Usu√°rios s√≥ veem seus dados
   - Admins explicitamente definidos

4. **Fail secure**
   - Em erro, negar acesso
   - Timeouts com fallback
   - Valida√ß√£o rigorosa

### Tokens e Sess√µes

**JWT Token**:
- Dura√ß√£o: 1 hora
- Armazenado em cookie HTTP-only
- Refresh autom√°tico antes de expirar

**Refresh Token**:
- Dura√ß√£o: 30 dias (padr√£o Supabase)
- Usado para gerar novo JWT
- Revogado ao fazer logout

**Session Storage**:
- Cookies: `sb-access-token`, `sb-refresh-token`
- localStorage: usado pelo Supabase client
- Limpo ao fazer logout

### Rate Limiting

**Supabase** (configurado no dashboard):
- Login: 5 tentativas por hora por IP
- Registro: 10 por hora por IP
- Recupera√ß√£o senha: 3 por hora por email

**Future**: Implementar rate limiting adicional no middleware

---

## üîß Configura√ß√£o

### Vari√°veis de Ambiente

```env
# Obrigat√≥rias
NEXT_PUBLIC_SUPABASE_URL=https://xxx.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=eyJxxx...
SUPABASE_SERVICE_ROLE_KEY=eyJxxx...  # NUNCA expor ao cliente!

# Opcionais
NEXT_PUBLIC_APP_URL=http://localhost:3000  # Para redirects
NODE_ENV=development  # Controla logs (via logger.ts)
```

### Configura√ß√£o Supabase Dashboard

**Authentication > Settings**:
```
‚òë Enable email confirmations
‚òë Double confirm email changes
‚òê Disable phone confirmations (n√£o usado)
‚òë Enable custom SMTP (recomendado para produ√ß√£o)
```

**Authentication > URL Configuration**:
```
Site URL: http://localhost:3000 (dev) | https://seu-dominio.com (prod)
Redirect URLs: 
  - http://localhost:3000/**
  - https://seu-dominio.com/**
```

**Authentication > Email Templates**:
- Customizar templates (ver `EMAIL-TEMPLATES.md`)
- Usar logo e cores da marca
- Mensagens em portugu√™s

---

## üêõ Troubleshooting

### "Auth session missing!"

**Causa**: Usu√°rio n√£o est√° autenticado  
**Solu√ß√£o**: Esperado quando n√£o h√° sess√£o. N√£o √© erro cr√≠tico.

**No c√≥digo**:
```typescript
// src/lib/auth.ts
if (authError) {
  logger.debug("‚ÑπÔ∏è Sess√£o n√£o encontrada:", authError.message);
  return null; // N√£o √© erro, apenas sem sess√£o
}
```

### "Timeout ao buscar profile"

**Causa**: Banco de dados lento ou conex√£o ruim  
**Solu√ß√£o**: Timeout aumentado para 8s com fallback

**No c√≥digo**:
```typescript
// src/lib/auth.ts
const timeoutPromise = new Promise((_, reject) => 
  setTimeout(() => reject(new Error("Timeout")), 8000)
);
```

### Loop de redirecionamento

**Causa**: Middleware e p√°gina em conflito  
**Solu√ß√£o**: 
1. Verificar que existe APENAS `src/app/(protected)/page.tsx`
2. N√ÉO deve existir `src/app/page.tsx`
3. Reiniciar servidor dev

### Sess√£o n√£o persiste

**Causa**: Cookies n√£o est√£o sendo salvos  
**Solu√ß√£o**:
1. Verificar que `@supabase/ssr` est√° instalado
2. Verificar que middleware usa `createServerClient`
3. Limpar cookies e localStorage

---

## üìä M√©tricas e Monitoramento

### Logs em Desenvolvimento

```typescript
// src/lib/logger.ts
// S√≥ exibe em NODE_ENV=development
logger.debug("üîç Info de debug");
logger.warn("‚ö†Ô∏è Aviso");

// Sempre exibe
logger.error("‚ùå Erro cr√≠tico");
```

### Logs no Middleware

```
üîç Middleware executado para: /
üìç Sess√£o encontrada: ‚úÖ SIM
üìß Email: usuario@exemplo.com
‚úÖ Middleware: Acesso autorizado para /
```

### Auditoria (Future)

Implementar tabela de auditoria:
```sql
CREATE TABLE auth_audit_log (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID REFERENCES auth.users(id),
  action TEXT NOT NULL, -- 'login', 'logout', 'failed_login'
  ip_address INET,
  user_agent TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW()
);
```

---

## üöÄ Performance

### Otimiza√ß√µes Implementadas

1. **Cache de usu√°rio**: Context evita m√∫ltiplas queries
2. **Timeout razo√°vel**: 8s para evitar warnings
3. **Fallback de profile**: Continua sem profile se timeout
4. **Bundle otimizado**: Components code-split
5. **Lazy loading**: AuthGuard s√≥ carrega quando necess√°rio

### M√©tricas Esperadas

- **Login**: < 2s
- **Verifica√ß√£o de auth**: < 1s
- **Middleware**: < 500ms
- **Bundle auth**: ~50KB

---

## üìö Refer√™ncias

### Documenta√ß√£o Externa

- [Supabase Auth Docs](https://supabase.com/docs/guides/auth)
- [Next.js Middleware](https://nextjs.org/docs/app/building-your-application/routing/middleware)
- [Next.js Route Groups](https://nextjs.org/docs/app/building-your-application/routing/route-groups)
- [@supabase/ssr](https://github.com/supabase/auth-helpers)

### Documenta√ß√£o Interna

- `PLANEJAMENTO-AUTENTICACAO.md` - Fases 1-12
- `FLUXOS.md` - Diagramas de fluxo
- `AUTH-DEVELOPER-GUIDE.md` - Guia pr√°tico
- `FASE-*-IMPLEMENTACAO.md` - Detalhes de cada fase

---

**Documento atualizado**: 2025-10-22  
**Vers√£o do Sistema**: 1.0.0  
**Mantenedor**: Marcos Rocha


